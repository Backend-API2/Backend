name: ğŸš€ CI/CD Pipeline with Code Coverage

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]

jobs:
  # ğŸ§ª Job de Testing con Coverage (siempre se ejecuta)
  test-with-coverage:
    name: ğŸ§ª Test & Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para cobertura histÃ³rica

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ“¦ Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: ğŸ§ª Run Tests with Coverage
        run: |
          cd Backend
          mvn clean test jacoco:report
        env:
          MAVEN_OPTS: -Xmx1024m

      - name: ğŸ“Š Generate Coverage Report
        run: |
          cd Backend
          mvn jacoco:report

      - name: ğŸ“ˆ Upload Coverage Reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            Backend/target/site/jacoco/
            Backend/target/jacoco.exec
          retention-days: 30

      - name: ğŸ“‹ Coverage Summary
        run: |
          cd Backend
          echo "ğŸ“Š COVERAGE SUMMARY"
          echo "=================="
          if [ -f target/site/jacoco/index.html ]; then
            echo "âœ… Coverage report generated successfully"
            echo "ğŸ“ Report location: target/site/jacoco/index.html"
          else
            echo "âŒ Coverage report not found"
            exit 1
          fi

      - name: ğŸš¨ Check Coverage Thresholds
        run: |
          cd Backend
          mvn jacoco:check
        continue-on-error: true

      - name: ğŸ“Š Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              // Leer el reporte de cobertura
              const reportPath = 'Backend/target/site/jacoco/jacoco.xml';
              if (fs.existsSync(reportPath)) {
                const report = fs.readFileSync(reportPath, 'utf8');
                
                // Extraer mÃ©tricas bÃ¡sicas (simplificado)
                const instructionMatch = report.match(/type="INSTRUCTION".*missed="(\d+)".*covered="(\d+)"/);
                const branchMatch = report.match(/type="BRANCH".*missed="(\d+)".*covered="(\d+)"/);
                
                if (instructionMatch && branchMatch) {
                  const instructionMissed = parseInt(instructionMatch[1]);
                  const instructionCovered = parseInt(instructionMatch[2]);
                  const instructionTotal = instructionMissed + instructionCovered;
                  const instructionCoverage = ((instructionCovered / instructionTotal) * 100).toFixed(2);
                  
                  const branchMissed = parseInt(branchMatch[1]);
                  const branchCovered = parseInt(branchMatch[2]);
                  const branchTotal = branchMissed + branchCovered;
                  const branchCoverage = ((branchCovered / branchTotal) * 100).toFixed(2);
                  
                  const comment = `## ğŸ“Š Code Coverage Report
                  
                  | Metric | Coverage | Status |
                  |--------|----------|--------|
                  | **Instructions** | ${instructionCoverage}% | ${instructionCoverage >= 60 ? 'âœ…' : 'âŒ'} |
                  | **Branches** | ${branchCoverage}% | ${branchCoverage >= 50 ? 'âœ…' : 'âŒ'} |
                  
                  ğŸ“ **Detailed Report**: Available in artifacts
                  ğŸ¯ **Target**: Instructions â‰¥60%, Branches â‰¥50%
                  
                  ${instructionCoverage < 60 || branchCoverage < 50 ? 'âš ï¸ **Coverage below threshold!** Please add more tests.' : 'ğŸ‰ **Great coverage!** Keep it up!'}`;
                  
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: comment
                  });
                }
              }
            } catch (error) {
              console.log('Could not generate coverage comment:', error.message);
            }

      - name: ğŸ—ï¸ Build Application
        run: |
          cd Backend
          mvn clean package -DskipTests

      - name: ğŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v3
        with:
          name: backend-jar
          path: Backend/target/*.jar
          retention-days: 7

  # ğŸš€ Job de Deployment (solo en push a master)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test-with-coverage
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Download JAR
        uses: actions/download-artifact@v3
        with:
          name: backend-jar

      - name: ğŸ“Š Download Coverage Reports
        uses: actions/download-artifact@v3
        with:
          name: coverage-reports

      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment process..."

            # ğŸ›‘ MÃ©todo 1: Script de Stop
            if [ -f /home/ec2-user/app/scripts/stop.sh ]; then
              echo "ğŸ“‹ Using stop script..."
              cd /home/ec2-user/app/scripts && ./stop.sh
            else
              echo "âš ï¸ Stop script not found, using alternative cleanup..."
            fi

            # ğŸ›‘ MÃ©todo 2: Cleanup por Puerto
            echo "ğŸ” Cleaning up port 8080..."
            if command -v lsof >/dev/null 2>&1; then
              PIDS=$(lsof -ti:8080)
              if [ ! -z "$PIDS" ]; then
                echo "ğŸ›‘ Killing processes on port 8080: $PIDS"
                echo $PIDS | xargs kill -TERM
                sleep 5
                echo $PIDS | xargs kill -KILL 2>/dev/null || true
              fi
            fi

            # ğŸ›‘ MÃ©todo 3: Cleanup por Proceso Java
            echo "â˜• Cleaning up Java Backend processes..."
            pkill -f 'java.*Backend' || true
            sleep 2

            # ğŸ›‘ MÃ©todo 4: Cleanup de PID Files
            echo "ğŸ“ Cleaning up PID files..."
            rm -f /home/ec2-user/app/*.pid
            rm -f /home/ec2-user/app/scripts/*.pid

            # ğŸ›‘ MÃ©todo 5: Cleanup Final
            echo "ğŸ§¹ Final cleanup..."
            if command -v lsof >/dev/null 2>&1; then
              FINAL_PIDS=$(lsof -ti:8080)
              if [ ! -z "$FINAL_PIDS" ]; then
                echo "âŒ Port 8080 still occupied by: $FINAL_PIDS"
                echo "ğŸ›‘ Force killing remaining processes..."
                echo $FINAL_PIDS | xargs kill -KILL
                sleep 2
              fi
            fi

            # ğŸ“¦ Copiar nuevo JAR
            echo "ğŸ“¦ Copying new JAR..."
            cp /tmp/Backend-*.jar /home/ec2-user/app/

            # ğŸš€ Iniciar aplicaciÃ³n
            echo "ğŸš€ Starting application..."
            cd /home/ec2-user/app
            nohup java -jar -Dspring.profiles.active=prod Backend-*.jar > app.log 2>&1 &
            echo $! > app.pid

            # â³ Esperar inicio
            echo "â³ Waiting for application to start..."
            sleep 30

            # ğŸ¥ Health Check con Retry Logic
            echo "ğŸ¥ Performing health checks..."
            MAX_ATTEMPTS=5
            ATTEMPT=1

            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ğŸ”„ Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
              
              if curl -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
                echo "âœ… Actuator health check passed"
                break
              else
                echo "âŒ Actuator health check failed"
                if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                  echo "ğŸ’¥ All health check attempts failed!"
                  exit 1
                fi
                sleep 10
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done

            # ğŸ¥ Custom Health Check
            ATTEMPT=1
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ğŸ”„ Custom health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
              
              if curl -f http://localhost:8080/health >/dev/null 2>&1; then
                echo "âœ… Custom health check passed"
                break
              else
                echo "âŒ Custom health check failed"
                if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                  echo "ğŸ’¥ All custom health check attempts failed!"
                  exit 1
                fi
                sleep 10
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done

            # âœ… VerificaciÃ³n final
            echo "âœ… Final verification..."
            curl -f http://localhost:8080/actuator/health
            curl -f http://localhost:8080/health

            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸ“Š Application is running and healthy"
            echo "ğŸŒ Health endpoints verified"

  # ğŸ“Š Job de Coverage Summary (solo en master)
  coverage-summary:
    name: ğŸ“Š Coverage Summary
    runs-on: ubuntu-latest
    needs: test-with-coverage
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Download Coverage Reports
        uses: actions/download-artifact@v3
        with:
          name: coverage-reports

      - name: ğŸ“ˆ Publish Coverage to GitHub
        run: |
          echo "ğŸ“Š Coverage reports available in artifacts"
          echo "ğŸ“ Location: Backend/target/site/jacoco/"
          echo "ğŸ¯ Coverage thresholds: Instructions â‰¥60%, Branches â‰¥50%"
